<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Trip</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="styles/editStyles.css">
    
    <!-- Add Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
    
    <!-- Add your configuration files -->
    <script src="/admin/firebaseConfig.js"></script>
    <script type="module" src="/admin/config.js"></script>
    <script>
        // Check authentication
        if (!sessionStorage.getItem('isAuthenticated')) {
            window.location.href = '/admin/';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeFirebase();
                console.log('Firebase initialized successfully');
                
                // Load user data and initialize form
                import('/admin/formHandler.js').then(module => {
                    console.log('Form handler loaded, initializing...');
                    module.initializeForm();
                });
            } catch (error) {
                console.error('Failed to initialize:', error);
            }
        });
    </script>
</head>
<body>
    <div class="page-container">
        <!-- Header Section -->
        <div class="header-container">
            <div class="user-welcome">
                <img id="userProfilePic" src="/assets/Butterfly2.png" alt="Profile Picture" class="profile-pic">
                <h1 id="welcomeHeader">Welcome to Cipher</h1>
            </div>
            <p class="welcome-text">
                Edit your trip details below. All changes will be saved automatically to your Cipher profile.
            </p>
        </div>

        <!-- Main Content -->
        <div class="content-container">
            <!-- Left Column -->
            <div class="form-column">
                <h2 class="column-header">Basic Info</h2>
                <form id="tripForm">
                    <div class="form-group">
                        <label for="title">Title</label>
                        <input type="text" id="title" maxlength="40" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="monthSelect">Month</label>
                            <select id="monthSelect"></select>
                        </div>
                        <div class="form-group">
                            <label for="yearSelect">Year</label>
                            <select id="yearSelect"></select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="numDays"># of Days</label>
                            <input type="number" id="numDays" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="numPeople"># of People</label>
                            <input type="number" id="numPeople" min="1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="familyType">Trip Type</label>
                        <select id="familyType" required></select>
                    </div>

                    <div class="form-group">
                        <label for="shortDescription">Trip Summary</label>
                        <textarea id="shortDescription" rows="2" maxlength="190" required></textarea>
                        <div id="charCounter" class="char-counter">0/190 characters</div>
                    </div>

                    <div class="form-group">
                        <label for="longDescription">Trip Notes</label>
                        <textarea id="longDescription"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="coverImage">Cover Image</label>
                        <input type="file" id="coverImage" accept="image/*">
                        <div class="img-container">
                            <img id="imageToEdit">
                        </div>
                        <div class="cropper-instructions" style="display: none;">
                            <p>Drag the image or resize the box to adjust your crop area</p>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Right Column -->
            <div class="form-column">
                <div class="tabs">
                    <button class="tab active" data-tab="places">Places</button>
                    <button class="tab" data-tab="photos">Photos</button>
                </div>

                <!-- Places Tab -->
                <div id="placesTab" class="tab-content active">
                    <div class="form-group">
                        <label for="placesAutocomplete">Search Places</label>
                        <input type="text" id="placesAutocomplete" placeholder="Enter location">
                        <ul id="placesList" class="places-list"></ul>
                        <label>Saved Places</label>
                        <ul id="savedPlacesList" class="saved-places-list"></ul>
                    </div>
                </div>

                <!-- Photos Tab -->
                <div id="photosTab" class="tab-content">
                    <div class="form-group">
                        <div class="image-grid">
                            <button type="button" class="add-photos-button">
                                <svg viewBox="0 0 24 24">
                                    <path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/>
                                </svg>
                                Add Photos
                            </button>
                            <input type="file" id="tripImages" accept="image/*" multiple style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitButton">
            <span class="loading-spinner"></span>
            <span class="button-text">Save Changes</span>
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
    <script src="places.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize TinyMCE
        tinymce.init({
            selector: '#longDescription',
            height: 300,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | formatselect | ' +
                'bold italic backcolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 16px }'
        });

        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add active class to clicked tab and corresponding content
                tab.classList.add('active');
                const tabName = tab.getAttribute('data-tab');
                document.getElementById(`${tabName}Tab`).classList.add('active');
            });
        });

        // Add Photos button functionality
        const addPhotosButton = document.querySelector('.add-photos-button');
        const tripImagesInput = document.getElementById('tripImages');

        addPhotosButton.addEventListener('click', () => {
            tripImagesInput.click();
        });

        // Lightbox functionality
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = lightbox.querySelector('.lightbox-image');
        const lightboxClose = lightbox.querySelector('.lightbox-close');

        function openLightbox(imageSrc) {
            lightboxImage.src = imageSrc;
            lightbox.classList.add('active');
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            lightboxImage.src = '';
        }

        // Close lightbox when clicking close button
        lightboxClose.addEventListener('click', closeLightbox);

        // Close lightbox when clicking outside the image
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) {
                closeLightbox();
            }
        });

        // Close lightbox with escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && lightbox.classList.contains('active')) {
                closeLightbox();
            }
        });

        // Update the image creation code
        tripImagesInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (!files.length) return;

            const imageGrid = document.querySelector('.image-grid');
            
            for (const file of files) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const thumbnailContainer = document.createElement('div');
                    thumbnailContainer.className = 'image-thumbnail-container';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-thumbnail';
                    
                    // Add click handler to the new image
                    img.addEventListener('click', () => {
                        openLightbox(img.src);
                    });
                    
                    thumbnailContainer.appendChild(img);
                    imageGrid.insertBefore(thumbnailContainer, addPhotosButton);
                };
                
                reader.readAsDataURL(file);
            }
            
            event.target.value = '';
        });

        // Add this near the top of your initialization code
        const familyTypeSelect = document.getElementById('familyType');
        
        // Populate trip types from config
        TRIP_TYPES.forEach(type => {
            const option = document.createElement('option');
            option.value = type.value;
            option.textContent = type.label;
            familyTypeSelect.appendChild(option);
        });
    });
    </script>

    <!-- Add this right before closing body tag -->
    <div class="lightbox" id="lightbox">
        <button class="lightbox-close">&times;</button>
        <img class="lightbox-image" src="" alt="Full size image">
    </div>
</body>
</html>