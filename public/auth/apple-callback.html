<!DOCTYPE html>
<html>
<head>
    <title>Apple Auth Callback</title>
</head>
<body>
    <div id="status">Processing authentication...</div>
    <script>
        console.log('Callback page loaded at:', window.location.href);
        
        // Function to handle parameters from either source
        function getAuthParams() {
            // Try URL parameters first (our test case)
            const urlParams = new URLSearchParams(window.location.search);
            
            // If no URL params, try form data (Apple's case)
            if (!urlParams.get('id_token')) {
                console.log('No URL parameters, checking form data...');
                const forms = document.getElementsByTagName('form');
                if (forms.length > 0) {
                    const formData = new FormData(forms[0]);
                    console.log('Form data found:', formData);
                    return {
                        id_token: formData.get('id_token'),
                        code: formData.get('code'),
                        state: formData.get('state')
                    };
                }
            }
            
            // Return URL parameters if they exist
            return {
                id_token: urlParams.get('id_token'),
                code: urlParams.get('code'),
                state: urlParams.get('state')
            };
        }

        // Get parameters from either source
        const { id_token, code, state } = getAuthParams();
        console.log('Auth parameters:', { id_token, code, state });
        
        if (!id_token || !code) {
            document.getElementById('status').textContent = 'Error: Missing authentication data';
            console.error('Missing auth data:', { id_token, code, state });
        } else {
            // Try to send message to opener window
            if (window.opener) {
                try {
                    console.log('Sending message to opener');
                    window.opener.postMessage({
                        type: 'apple-auth',
                        id_token,
                        code,
                        state
                    }, window.location.origin);
                    
                    document.getElementById('status').textContent = 'Authentication complete!';
                    // Close after a short delay
                    setTimeout(() => window.close(), 1000);
                } catch (error) {
                    document.getElementById('status').textContent = 'Error: ' + error.message;
                    console.error('Error sending message:', error);
                }
            } else {
                // If opened directly (not as popup)
                document.getElementById('status').textContent = 'Please return to the main page and try again';
                console.log('No opener window found - page was opened directly');
            }
        }
    </script>
</body>
</html>