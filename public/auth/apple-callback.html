<!DOCTYPE html>
<html>
<head>
    <title>Apple Auth Callback</title>
</head>
<body>
    <div id="status">Processing authentication...</div>
    <script>
        console.log('Callback page loaded');
        
        // Handle form_post response
        const params = new URLSearchParams(window.location.search);
        const id_token = params.get('id_token');
        const code = params.get('code');
        const state = params.get('state');

        console.log('Received response:', { id_token, code, state });

        document.getElementById('status').textContent = 'Received response, processing...';

        // Send the tokens back to the opener window
        if (window.opener) {
            try {
                window.opener.postMessage({
                    type: 'apple-auth',
                    id_token,
                    code,
                    state
                }, window.location.origin);
                
                document.getElementById('status').textContent = 'Authentication complete, closing window...';
                window.close();
            } catch (error) {
                document.getElementById('status').textContent = 'Error: ' + error.message;
                console.error('Error sending message:', error);
            }
        } else {
            document.getElementById('status').textContent = 'Error: Opener window not found';
        }
    </script>
</body>
</html>